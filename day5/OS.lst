     1                                  ; haribote-os
     2                                  
     3                                  
     4                                  BOTPAK  EQU   0x00280000  ; 加载bootpack
     5                                  DSKCAC  EQU   0x00100000  ; 磁盘缓存的位置
     6                                  DSKCAC0 EQU   0x00008000  ; 实模式磁盘缓存的位置
     7                                  
     8                                  ; 有关BOOT_INFO
     9                                  CYLS    EQU   0x0ff0      ; 设置启动区
    10                                  LEDS    EQU   0x0ff1
    11                                  VMODE   EQU   0x0ff2      ; 关于颜色数目的信息，颜色的位数
    12                                  SCRNX   EQU   0x0ff4      ; 分辨率X
    13                                  SCRNY   EQU   0x0ff6      ; 分辨率Y
    14                                  VRAM    EQU   0x0ff8      ; 图像缓冲区的起始位置
    15                                  
    16                                    ; 使用linker script指定起始地址
    17                                    ORG   0xc200            ; 程序被加载的内存地址
    18                                  
    19                                    [BITS 16]
    20                                  entry:
    21                                  ; 设置屏幕模式
    22 00000000 B013                      MOV   AL, 0x13          ; VGA显卡，320x200x8 bit
    23 00000002 B400                      MOV   AH, 0x00
    24 00000004 CD10                      INT   0x10
    25                                  
    26 00000006 C606F20F08                MOV   BYTE [VMODE], 8   ; 屏幕的模式
    27 0000000B C706F40F4001              MOV   WORD [SCRNX], 320
    28 00000011 C706F60FC800              MOV   WORD [SCRNY], 200
    29 00000017 66C706F80F00000A00        MOV   DWORD [VRAM], 0x000a0000
    30                                  
    31                                  ; 用BIOS取得键盘上各种LED指示灯的状态
    32 00000020 B402                      MOV   AH, 0x02
    33 00000022 CD16                      INT   0x16              ; 键盘BIOS
    34 00000024 A2F10F                    MOV   [LEDS], AL
    35                                  
    36                                  ; 防止PIC接受所有中断
    37                                  ;   根据AT兼容机的规范初始化PIC
    38                                  ;   如果没有在CLI指令前执行可能会挂起
    39                                  ;   并继续初始化PIC
    40 00000027 B0FF                      MOV   AL, 0xff
    41 00000029 E621                      OUT   0x21, AL
    42 0000002B 90                        NOP                     ; 有些机器不能连续执行NOP指令
    43 0000002C E6A1                      OUT   0xa1, AL
    44                                  
    45 0000002E FA                        CLI
    46                                  
    47                                  ; 设置A20GATE使CPU支持1M以上的内存
    48 0000002F E89100                    CALL  waitkbdout
    49 00000032 B0D1                      MOV   AL, 0xd1
    50 00000034 E664                      OUT   0x64, AL
    51 00000036 E88A00                    CALL  waitkbdout
    52 00000039 B0DF                      MOV   AL, 0xdf          ; 开启A20
    53 0000003B E660                      OUT   0x60, AL
    54 0000003D E88300                    CALL  waitkbdout
    55                                  
    56                                  ; 切换到保护模式
    57 00000040 0F0116[0A01]              LGDT  [GDTR0]           ; 设置临时GDT
    58 00000045 0F20C0                    MOV   EAX, CR0
    59 00000048 6625FFFFFF7F              AND   EAX, 0x7fffffff   ; 禁用分页
    60 0000004E 6683C801                  OR    EAX, 0x00000001   ; 开启保护模式
    61 00000052 0F22C0                    MOV   CR0, EAX
    62 00000055 EB00                      JMP   pipelineflush
    63                                  
    64                                  pipelineflush:
    65 00000057 B80800                    MOV   AX, 1*8           ; 写32bit段
    66 0000005A 8ED8                      MOV   DS, AX
    67 0000005C 8EC0                      MOV   ES, AX
    68 0000005E 8EE0                      MOV   FS, AX
    69 00000060 8EE8                      MOV   GS, AX
    70 00000062 8ED0                      MOV   SS, AX
    71                                  
    72                                  ; bootpack传递
    73 00000064 66BE[10010000]            MOV   ESI, bootpack     ; 源
    74 0000006A 66BF00002800              MOV   EDI, BOTPAK       ; 目标
    75 00000070 66B900000200              MOV   ECX, 512*1024/4
    76 00000076 E85100                    CALL  memcpy
    77                                  
    78                                  ; 传输磁盘数据
    79                                  
    80                                  ; 从引导区开始
    81                                  
    82 00000079 66BE007C0000              MOV   ESI, 0x7c00       ; 源
    83 0000007F 66BF00001000              MOV   EDI, DSKCAC       ; 目标
    84 00000085 66B980000000              MOV   ECX, 512/4
    85 0000008B E83C00                    CALL  memcpy
    86                                  
    87                                  ; 剩余的全部
    88 0000008E 66BE00820000              MOV   ESI, DSKCAC0+512  ; 源
    89 00000094 66BF00021000              MOV   EDI, DSKCAC+512   ; 目标
    90 0000009A 66B900000000              MOV   ECX, 0
    91 000000A0 8A0EF00F                  MOV   CL, BYTE [CYLS]
    92 000000A4 6669C900120000            IMUL  ECX, 512*18*2/4   ; 除以4得到字节数
    93 000000AB 6681E980000000            SUB   ECX, 512/4        ; IPL偏移量
    94 000000B2 E81500                    CALL  memcpy
    95                                  
    96                                  skip:
    97 000000B5 66BCFFFF0000              MOV   ESP, 0xffff
    98 000000BB 66EA000000001000          JMP   DWORD 2*8:0x00000000
    99                                  
   100                                  waitkbdout:
   101 000000C3 E464                      IN    AL, 0x64
   102 000000C5 2402                      AND   AL, 0x02
   103 000000C7 75FA                      JNZ   waitkbdout        ; AND结果不为0跳转至waitkbdout
   104 000000C9 C3                        RET
   105                                  
   106                                  memcpy:
   107 000000CA 66678B06                  MOV   EAX, [ESI]
   108 000000CE 6683C604                  ADD   ESI, 4
   109 000000D2 66678907                  MOV   [EDI], EAX
   110 000000D6 6683C704                  ADD   EDI, 4
   111 000000DA 6683E901                  SUB   ECX, 1
   112 000000DE 75EA                      JNZ   memcpy            ; 结果不为0跳转至memcpy
   113 000000E0 C3                        RET
   114                                  ; memcpy地址前缀大小
   115                                  
   116 000000E1 90<rep Fh>                ALIGN 16
   117                                  GDT0:
   118 000000F0 ????????????????          RESB  8                 ; 初始值
   118          ******************       warning: uninitialized space declared in .text section: zeroing [-w+zeroing]
   119 000000F8 FFFF00000092CF00          DW    0xffff, 0x0000, 0x9200, 0x00cf  ; 可写的32位段寄存器
   120 00000100 FFFF0000289A4700          DW    0xffff, 0x0000, 0x9a28, 0x0047  ; 可执行的文件的32位寄存器
   121                                  
   122 00000108 0000                      DW    0
   123                                  
   124                                  GDTR0:
   125 0000010A 1700                      DW    8*3-1
   126 0000010C [F0000000]                DD    GDT0
   127                                  
   128                                    ALIGN 16
   129                                  bootpack:
